
import React, { useState, useEffect, useRef } from 'react';
import { ClientData, MonthlyStat } from '../types';
import { saveClient } from '../services/firebase';

interface Props {
  data: Partial<ClientData>;
  onBack: () => void;
}

const PERIOD_ORDER = ['Ponta', 'Cheias', 'Vazio', 'Super Vazio'];

// --- UI HELPERS ---

const EditableText: React.FC<{
    value: string;
    onChange: (val: string) => void;
    className?: string;
    alignment?: 'left' | 'center' | 'right' | 'justify';
    multiline?: boolean;
    placeholder?: string;
    isWhite?: boolean;
}> = ({ value, onChange, className, alignment = 'left', placeholder, isWhite = false }) => (
    <div
        contentEditable
        suppressContentEditableWarning
        onBlur={(e) => onChange(e.currentTarget.textContent || "")}
        className={`outline-none min-h-[1.2em] empty:before:content-[attr(data-placeholder)] empty:before:text-gray-400 cursor-text border border-transparent hover:border-gray-400 rounded px-1 transition-colors whitespace-pre-wrap ${className} ${isWhite ? 'text-white' : 'text-black'}`}
        style={{ textAlign: alignment }}
        data-placeholder={placeholder}
    >
        {value}
    </div>
);

const EditableNumber: React.FC<{
    value: number;
    onChange: (val: number) => void;
    className?: string;
    format?: 'currency' | 'decimal' | 'percent';
    digits?: number;
    bold?: boolean;
    colorClass?: string;
}> = ({ value, onChange, className, format = 'decimal', digits = 2, bold = false, colorClass = 'text-black' }) => {
    const [isEditing, setIsEditing] = useState(false);
    const [tempVal, setTempVal] = useState(value.toString());

    useEffect(() => { setTempVal(value.toString()) }, [value]);

    const handleBlur = () => {
        setIsEditing(false);
        const parsed = parseFloat(tempVal.replace(/\./g, '').replace(',', '.').replace(/[^0-9.-]/g, ''));
        if (!isNaN(parsed)) onChange(parsed);
        else setTempVal(value.toString());
    };

    if (isEditing) {
        return (
            <input 
                autoFocus
                value={tempVal}
                onChange={e => setTempVal(e.target.value)}
                onBlur={handleBlur}
                className={`bg-white outline-none border border-blue-500 w-full text-right px-1 text-black font-mono ${className}`}
            />
        );
    }

    let display = tempVal;
    if (format === 'currency') display = value.toLocaleString('pt-PT', { minimumFractionDigits: digits, maximumFractionDigits: digits }) + ' ‚Ç¨';
    else if (format === 'decimal') display = value.toLocaleString('pt-PT', { minimumFractionDigits: digits, maximumFractionDigits: digits });
    else if (format === 'percent') display = value.toFixed(1) + '%';

    return (
        <span onClick={() => setIsEditing(true)} className={`cursor-pointer hover:bg-yellow-200 px-1 rounded transition-colors ${colorClass} ${bold ? 'font-black' : 'font-bold'} ${className}`}>
            {display}
        </span>
    );
};

const ImagePlaceholder: React.FC<{
    src: string;
    onUpload: (val: string) => void;
    label: string;
    className?: string;
    classNameContainer?: string;
    contain?: boolean;
}> = ({ src, onUpload, label, className, classNameContainer, contain = true }) => {
    const handleUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files?.[0]) {
            const reader = new FileReader();
            reader.onload = (ev) => onUpload(ev.target?.result as string);
            reader.readAsDataURL(e.target.files[0]);
        }
    };
    return (
        <div className={`relative group flex flex-col items-center justify-center overflow-hidden ${classNameContainer || ''} ${!src ? 'bg-gray-50 border-2 border-dashed border-gray-400' : ''} ${className}`}>
            {src ? (
                <img src={src} alt={label} className={`w-full h-full ${contain ? 'object-contain' : 'object-cover'}`} />
            ) : (
                <div className="text-center p-4">
                    <div className="text-3xl mb-2 opacity-30 text-black">üì∑</div>
                    <div className="text-[9px] font-bold uppercase text-gray-600 tracking-wider">{label}</div>
                </div>
            )}
            <input type="file" accept="image/*" onChange={handleUpload} className="absolute inset-0 opacity-0 cursor-pointer no-print" />
        </div>
    );
};

// --- GAUGE DE RISCO (CANVAS) ---
const VulnerabilityGauge: React.FC<{ savingsPercent: number }> = ({ savingsPercent }) => {
    const canvasRef = useRef<HTMLCanvasElement>(null);

    let score = 2.0;
    if (savingsPercent > 35) score = 9.5;
    else if (savingsPercent > 25) score = 8.5;
    else if (savingsPercent > 15) score = 7.0;
    else if (savingsPercent > 8) score = 5.5;
    else score = 3.0;
    
    let label = "BAIXO";
    let colorClass = "text-watton-dark";
    if (score >= 8.5) { label = "CR√çTICO"; colorClass = "text-red-600"; }
    else if (score >= 6.5) { label = "ELEVADO"; colorClass = "text-orange-600"; }
    else if (score >= 4.5) { label = "MODERADO"; colorClass = "text-yellow-600"; }
    
    const rotation = -90 + ((score / 10) * 180);

    useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        const scale = 2;
        canvas.width = 160 * scale;
        canvas.height = 90 * scale; 
        ctx.scale(scale, scale);

        ctx.clearRect(0, 0, 160, 90);

        const centerX = 80;
        const centerY = 75;
        const radius = 60;
        const lineWidth = 12;

        const gradient = ctx.createLinearGradient(10, 0, 150, 0);
        gradient.addColorStop(0, '#2E5A27');
        gradient.addColorStop(0.5, '#EAB308');
        gradient.addColorStop(1, '#DC2626');

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, Math.PI, 0);
        ctx.lineWidth = lineWidth;
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineCap = 'butt';
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, Math.PI, 0);
        ctx.lineWidth = lineWidth;
        ctx.strokeStyle = gradient;
        ctx.lineCap = 'butt';
        ctx.stroke();

        ctx.font = "bold 10px sans-serif";
        ctx.fillStyle = "#9ca3af";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("0", centerX - radius - 10, centerY);
        ctx.fillText("10", centerX + radius + 10, centerY);

    }, []);

    return (
        <div className="relative w-40 h-28 flex flex-col items-center">
            <canvas ref={canvasRef} style={{width: '160px', height: '90px'}} />
            <div 
                className="absolute top-0 left-0 w-0 h-0"
                style={{
                    transform: `translate(80px, 75px) rotate(${rotation}deg)`,
                    zIndex: 20
                }}
            >
                 <div className="absolute bottom-0 left-[-1.5px] w-[3px] h-[60px] bg-black rounded-t-full"></div>
                 <div className="absolute top-[-4px] left-[-4px] w-[8px] h-[8px] bg-black rounded-full"></div>
            </div>
            <div className="absolute bottom-0 text-center flex flex-col items-center z-30">
                <span className="text-3xl font-black leading-none text-black drop-shadow-sm bg-white/80 px-1 rounded">{score.toFixed(1)}</span>
                <span className={`text-[9px] font-black uppercase tracking-widest ${colorClass} bg-white/80 px-1 rounded`}>Risco {label}</span>
            </div>
        </div>
    );
};

// --- PORTF√ìLIO SEC√á√ÉO ---
const WattonPortfolioSection: React.FC = () => (
    <div className="mt-4 pt-3 border-t border-gray-200">
        <h3 className="text-xs font-black text-watton-dark uppercase tracking-tight mb-3 flex items-center justify-between">
            <span>Portf√≥lio Watton: <span className="text-gray-500 font-medium normal-case ml-1">Solu√ß√µes de Otimiza√ß√£o e Sustentabilidade</span></span>
            <span className="text-[8px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full uppercase tracking-wider">Servi√ßos Premium</span>
        </h3>
        
        <div className="grid grid-cols-2 gap-x-8 gap-y-3">
            <div>
                <h4 className="text-[9px] font-bold text-watton-lime uppercase tracking-wide mb-1">1. Hedging Energ√©tico</h4>
                <p className="text-[8px] leading-relaxed text-gray-700 text-justify">
                    Transforme a volatilidade do mercado em vantagem competitiva. Atrav√©s de modelos de contrata√ß√£o din√¢micos, asseguramos <strong>previsibilidade or√ßamental</strong> e prote√ß√£o contra oscila√ß√µes de pre√ßo.
                </p>
            </div>
            <div>
                <h4 className="text-[9px] font-bold text-watton-lime uppercase tracking-wide mb-1">2. Solu√ß√µes de Carbono & ESG</h4>
                <p className="text-[8px] leading-relaxed text-gray-700 text-justify">
                    Apoio integral ao cumprimento da diretiva CSRD e Taxonomia da UE. Medi√ß√£o rigorosa da <strong>Pegada de Carbono</strong> e An√°lise de Dupla Materialidade.
                </p>
            </div>
            <div>
                <h4 className="text-[9px] font-bold text-watton-lime uppercase tracking-wide mb-1">3. Cart√µes Frota & Mobilidade 360¬∫</h4>
                <p className="text-[8px] leading-relaxed text-gray-700 text-justify">
                    Plataforma unificada que integra cart√µes de combust√≠vel e carregamento el√©trico. Inclui <strong>telemetria GPS</strong> e gest√£o de portagens europeias.
                </p>
            </div>
             <div>
                <h4 className="text-[9px] font-bold text-watton-lime uppercase tracking-wide mb-1">4. Roteiro de Descarboniza√ß√£o</h4>
                <p className="text-[8px] leading-relaxed text-gray-700 text-justify">
                    Defini√ß√£o estrat√©gica rumo √† neutralidade carb√≥nica (Net Zero), alinhada com a iniciativa <strong>Science Based Targets (SBTi)</strong>.
                </p>
            </div>
        </div>
    </div>
);

// --- FOOTER ---
const ReportFooter: React.FC<{ logoSmall: string, onUpload: (s:string)=>void }> = ({ logoSmall, onUpload }) => (
    <div className="absolute bottom-0 left-0 right-0 h-[20mm] border-t-2 border-gray-200 flex justify-between items-center px-10 bg-white z-50">
        <div className="flex items-center gap-6">
             <div className="h-6 w-20 relative group">
                 <img src={logoSmall || "https://placehold.co/100x50/png?text=Watton"} className="h-full w-full object-contain opacity-100" />
                 <input type="file" onChange={e => {
                    if(e.target.files?.[0]) {
                        const r = new FileReader();
                        r.onload = ev => onUpload(ev.target?.result as string);
                        r.readAsDataURL(e.target.files[0]);
                    }
                 }} className="absolute inset-0 opacity-0 cursor-pointer no-print"/>
             </div>
             <div className="text-[6px] text-black font-bold leading-tight border-l-2 border-watton-lime pl-2">
                <strong className="text-watton-dark text-[7px]">WATTON ENERGY CONSULTING</strong><br/>
                Rua Professor Manuel Baganha 283<br/>
                Lj. A | 4350-009 Porto
             </div>
        </div>
        <div className="text-[6px] text-black font-medium leading-tight text-right">
            <span className="font-bold">T: +351 225 500 632</span><br/>
            E: geral@wattonenergy.pt<br/>
            <span className="text-watton-dark font-black tracking-wide">www.wattonenergy.pt</span>
        </div>
    </div>
);

// --- MAIN COMPONENT ---

export const VulnerabilityReport: React.FC<Props> = ({ data, onBack }) => {
  const reportRef = useRef<HTMLDivElement>(null);

  // --- STATE ---
  const [localStats, setLocalStats] = useState<MonthlyStat[]>(data.monthlyStats || []);
  const [days] = useState(data.daysInPeriod || 30);
  const [currentPowerDaily, setCurrentPowerDaily] = useState(data.dailyPowerCostEur || 0);
  const [wattonPowerDaily, setWattonPowerDaily] = useState(data.simulationConfig?.manualPowerPrice !== undefined ? data.simulationConfig.manualPowerPrice : 1.5249);
  
  const [logoUrl, setLogoUrl] = useState(data.reportData?.logoUrl || "");
  const [footerLogo, setFooterLogo] = useState("");
  const [marketGraphUrl, setMarketGraphUrl] = useState(data.reportData?.marketGraphUrl || "");
  const [predictionGraphUrl, setPredictionGraphUrl] = useState(data.reportData?.predictionGraphUrl || "");
  
  const [strategyText, setStrategyText] = useState(data.reportData?.strategyText || "A Watton Energy implementa uma estrat√©gia de Otimiza√ß√£o.");
  const [insightText, setInsightText] = useState(data.reportData?.insightText || "O contrato atual apresenta custos excessivos.");

  const [isGenerating, setIsGenerating] = useState(false);

  // --- C√ÅLCULOS ---
  const mappedStats = PERIOD_ORDER.map(p => {
      const existing = localStats.find(s => s.period.toLowerCase() === p.toLowerCase());
      if (existing) return existing;
      return { period: p, kwh: 0, currentUnit: 0, currentTotal: 0, wattonUnit: 0, wattonTotal: 0 } as MonthlyStat;
  });

  const totalPowerCurr = currentPowerDaily * days;
  const totalPowerWatton = wattonPowerDaily * days;

  const totalEnergyCurr = mappedStats.reduce((acc, s) => acc + s.currentTotal, 0);
  const totalEnergyWatton = mappedStats.reduce((acc, s) => acc + s.wattonTotal, 0);

  const grandTotalCurr = totalEnergyCurr + totalPowerCurr;
  const grandTotalWatton = totalEnergyWatton + totalPowerWatton;
  
  const monthlySavings = grandTotalCurr - grandTotalWatton;
  const annualSavings = (monthlySavings / days) * 365;
  
  const savingsPct = grandTotalCurr > 0 ? (monthlySavings / grandTotalCurr) * 100 : 0;

  const handleStatUpdate = (period: string, field: 'currentUnit' | 'wattonUnit', val: number) => {
    const newStats = [...localStats];
    const idx = newStats.findIndex(s => s.period.toLowerCase() === period.toLowerCase());
    if (idx > -1) {
        // @ts-ignore
        newStats[idx][field] = val;
        newStats[idx].currentTotal = newStats[idx].kwh * newStats[idx].currentUnit;
        newStats[idx].wattonTotal = newStats[idx].kwh * newStats[idx].wattonUnit;
        setLocalStats(newStats);
    }
  };

  const handleSave = async () => {
    if (data.id) {
        await saveClient({
            ...data as ClientData,
            reportData: {
                logoUrl, marketGraphUrl, predictionGraphUrl,
                strategyText, insightText
            }
        });
    }
  };

  const handleDownloadPDF = async () => {
    setIsGenerating(true);
    // CRITICAL FIX: Scroll to top to ensure html2pdf captures from 0,0
    window.scrollTo(0, 0);
    // CRITICAL FIX: Buffer time for React rendering (Images/Canvas)
    await new Promise(r => setTimeout(r, 2500)); 
    
    const element = reportRef.current;
    if (element && (window as any).html2pdf) {
        const opt = {
            margin: 0,
            filename: `Relatorio_Watton_${data.companyName?.replace(/\s+/g, '_')}.pdf`,
            image: { type: 'jpeg', quality: 1.0 },
            html2canvas: { scale: 3, useCORS: true, letterRendering: true, scrollX: 0, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        try {
            const pdfDataUri = await (window as any).html2pdf().set(opt).from(element).output('datauristring');
            const base64Content = pdfDataUri.split(',')[1];
            
            if (data.id) {
                await saveClient({
                    ...data as ClientData,
                    reportData: { logoUrl, marketGraphUrl, predictionGraphUrl, strategyText, insightText },
                    generatedReportFile: { name: opt.filename, data: base64Content, mimeType: 'application/pdf' }
                });
            }
            const link = document.createElement('a');
            link.href = pdfDataUri;
            link.download = opt.filename;
            link.click();
        } catch (e) {
            console.error("PDF Error", e);
            window.print();
        }
    } else {
        window.print();
    }
    setIsGenerating(false);
  };

  return (
    <div className="bg-gray-100 min-h-screen font-sans text-black">
       {/* TOOLBAR */}
       <div className="no-print fixed top-0 left-0 right-0 bg-[#050505] p-3 flex justify-between items-center z-50 shadow-md border-b border-gray-800">
        <button onClick={onBack} className="text-gray-400 hover:text-white text-sm font-bold flex items-center gap-2"><span>‚Üê Voltar</span></button>
        <div className="flex gap-2">
            <button onClick={handleSave} className="bg-gray-800 text-white px-5 py-2 rounded-lg text-xs font-bold hover:bg-gray-700 border border-gray-700">üíæ Gravar</button>
            <button onClick={handleDownloadPDF} disabled={isGenerating} className="bg-watton-lime text-black px-5 py-2 rounded-lg text-xs font-bold hover:bg-white transition shadow-[0_0_15px_rgba(139,197,63,0.3)]">{isGenerating ? 'A Gerar PDF...' : '‚¨á Download PDF (HD)'}</button>
        </div>
      </div>

      <div className="flex justify-center pt-24 pb-20">
        <div ref={reportRef} id="report-container" className="bg-white">
            
            {/* --- P√ÅGINA 1 --- */}
            <div className="relative flex flex-col p-10 pb-20 bg-white overflow-hidden" style={{ width: '210mm', height: '296mm', boxSizing: 'border-box', pageBreakAfter: 'always' }}>
                
                {/* HEADER */}
                <div className="flex justify-between items-start mb-4 border-b-2 border-black pb-3">
                    <div className="w-52 h-16 relative -ml-2">
                        <ImagePlaceholder src={logoUrl} onUpload={setLogoUrl} label="Logo Cliente" className="h-full border-none bg-transparent" contain={true} />
                    </div>
                    <div className="text-right pt-1">
                        <h1 className="text-3xl font-black text-watton-dark uppercase tracking-tighter leading-none mb-1">Relat√≥rio de<br/>Vulnerabilidade</h1>
                        <div className="text-[9px] font-bold text-black uppercase tracking-[0.3em]">Energy Intelligence Platform</div>
                    </div>
                </div>

                {/* DADOS */}
                <div className="grid grid-cols-12 gap-6 mb-4 items-end">
                    <div className="col-span-8">
                        <h3 className="text-[10px] font-black text-black uppercase tracking-widest mb-2 border-b border-gray-200 pb-0.5">Identifica√ß√£o</h3>
                        <div className="grid grid-cols-2 gap-y-2 gap-x-6">
                            <div><span className="text-[8px] text-gray-500 uppercase font-bold block mb-0.5">Empresa</span><span className="text-base font-bold text-black leading-none block">{data.companyName}</span></div>
                            <div><span className="text-[8px] text-gray-500 uppercase font-bold block mb-0.5">NIF / Contribuinte</span><span className="text-base font-bold text-black font-mono leading-none block">{data.nif}</span></div>
                            <div className="col-span-2 flex gap-4 mt-1">
                                <div><span className="text-[8px] text-gray-500 uppercase font-bold block mb-0.5">CPE</span><span className="text-[10px] font-bold text-black font-mono bg-gray-50 px-2 py-1 rounded border border-gray-200 block">{data.cpe}</span></div>
                                <div><span className="text-[8px] text-gray-500 uppercase font-bold block mb-0.5">Tens√£o</span><span className="text-[10px] font-bold text-black bg-gray-50 px-2 py-1 rounded border border-gray-200 block">{data.tensionLevel}</span></div>
                                <div><span className="text-[8px] text-gray-500 uppercase font-bold block mb-0.5">Hor√°rio</span><span className="text-[10px] font-bold text-black bg-gray-50 px-2 py-1 rounded border border-gray-200 block">{data.cycleType || 'Tri-Hor√°rio'}</span></div>
                                <div><span className="text-[8px] text-gray-500 uppercase font-bold block mb-0.5">Pot√™ncia</span><span className="text-[10px] font-bold text-black bg-gray-50 px-2 py-1 rounded border border-gray-200 block">{data.contractedPowerKw} kVA</span></div>
                            </div>
                        </div>
                    </div>
                    <div className="col-span-4 flex justify-end">
                        <div className="bg-white border border-gray-100 rounded-xl p-2 flex flex-col items-center shadow-sm w-full">
                            <VulnerabilityGauge savingsPercent={savingsPct} />
                        </div>
                    </div>
                </div>

                {/* TABELA */}
                <div className="mb-4">
                    <div className="flex justify-between items-end mb-1 border-b-2 border-black pb-1">
                        <h3 className="text-[10px] font-black text-black uppercase tracking-widest">An√°lise Econ√≥mica Detalhada</h3>
                        <span className="text-[8px] text-gray-500 font-bold uppercase">Valores sem IVA</span>
                    </div>
                    
                    <table className="w-full text-xs border-collapse">
                        <thead className="bg-black text-white">
                            <tr>
                                <th className="py-2 px-3 text-left font-bold uppercase tracking-wide w-[25%] border border-gray-400">Per√≠odo Hor√°rio</th>
                                <th className="py-2 px-3 text-right font-bold uppercase tracking-wide w-[15%] border border-gray-400">Consumo (kWh)</th>
                                <th className="py-2 px-3 text-right font-bold uppercase tracking-wide w-[20%] border border-gray-400">Pre√ßo Atual (‚Ç¨)</th>
                                <th className="py-2 px-3 text-right font-bold uppercase tracking-wide w-[20%] bg-watton-dark text-white border border-gray-400">Pre√ßo Watton (‚Ç¨)</th>
                                <th className="py-2 px-3 text-right font-bold uppercase tracking-wide w-[20%] bg-watton-lime text-black border border-gray-400">Poupan√ßa (‚Ç¨)</th>
                            </tr>
                        </thead>
                        <tbody className="text-sm">
                            {mappedStats.map((s, idx) => {
                                const savings = s.currentTotal - s.wattonTotal;
                                return (
                                    <tr key={idx}>
                                        <td className="py-1.5 px-3 font-bold text-black border border-gray-400">{s.period}</td>
                                        <td className="py-1.5 px-3 text-right font-bold text-black border border-gray-400">{s.kwh.toLocaleString()}</td>
                                        <td className="py-1.5 px-3 text-right font-bold text-black border border-gray-400">
                                            <EditableNumber value={s.currentUnit} onChange={v => handleStatUpdate(s.period, 'currentUnit', v)} digits={4} />
                                        </td>
                                        <td className="py-1.5 px-3 text-right font-bold text-black bg-gray-50 border border-gray-400">
                                            <EditableNumber value={s.wattonUnit} onChange={v => handleStatUpdate(s.period, 'wattonUnit', v)} digits={4} />
                                        </td>
                                        {/* SAVINGS COLUMN LOGIC: Positive Savings (Less Cost) = Green/Plus. Negative Savings (More Cost) = Red/Minus */}
                                        <td className={`py-1.5 px-3 text-right font-black border border-gray-400 ${savings < 0 ? 'text-red-600 bg-red-50' : 'text-black bg-watton-lime/10'}`}>
                                            {savings > 0 ? '+' : ''}{savings.toLocaleString('pt-PT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                        </td>
                                    </tr>
                                );
                            })}
                            <tr>
                                <td className="py-1.5 px-3 font-bold text-black bg-gray-100 border border-gray-400">Pot√™ncia ({days} dias)</td>
                                <td className="py-1.5 px-3 text-right italic text-gray-500 bg-gray-100 border border-gray-400">-</td>
                                <td className="py-1.5 px-3 text-right font-bold text-black bg-gray-100 border border-gray-400">
                                    <EditableNumber value={currentPowerDaily} onChange={setCurrentPowerDaily} digits={4} /> <span className="text-[9px] font-normal">/dia</span>
                                </td>
                                <td className="py-1.5 px-3 text-right font-bold text-black bg-gray-200 border border-gray-400">
                                    <EditableNumber value={wattonPowerDaily} onChange={setWattonPowerDaily} digits={4} /> <span className="text-[9px] font-normal">/dia</span>
                                </td>
                                <td className="py-1.5 px-3 text-right font-black text-black bg-watton-lime/20 border border-gray-400">
                                    {(totalPowerCurr - totalPowerWatton).toLocaleString('pt-PT', {minimumFractionDigits: 2})}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                {/* IMPACTO FINANCEIRO */}
                <div className="grid grid-cols-4 gap-4 mb-6 h-20">
                    <div className="bg-white border-2 border-gray-200 p-2 flex flex-col justify-between shadow-sm">
                        <span className="text-[8px] uppercase font-bold text-gray-400 tracking-widest text-center">Fatura Atual (Mensal)</span>
                        <div className="text-center"><span className="text-lg font-black text-black"><EditableNumber value={grandTotalCurr} onChange={()=>{}} digits={2} format="currency" bold/></span></div>
                    </div>
                    <div className={`border-2 p-2 flex flex-col justify-between ${monthlySavings < 0 ? 'bg-red-50 border-red-200' : 'bg-watton-lime/10 border-watton-lime/30'}`}>
                         <span className={`text-[8px] uppercase font-bold tracking-widest text-center ${monthlySavings < 0 ? 'text-red-700' : 'text-watton-dark'}`}>Poupan√ßa Mensal</span>
                         <div className="text-center">
                             <span className={`text-lg font-black ${monthlySavings < 0 ? 'text-red-600' : 'text-black'}`}>
                                {monthlySavings > 0 ? '+' : ''}{monthlySavings.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' })}
                             </span>
                         </div>
                    </div>
                    <div className={`border-2 p-2 flex flex-col justify-between shadow-md ${annualSavings < 0 ? 'bg-red-100 border-red-400' : 'bg-watton-lime border-watton-lime'}`}>
                         <span className="text-[8px] uppercase font-bold text-black tracking-widest text-center">Poupan√ßa Anual Est.</span>
                         <div className="text-center">
                             <span className={`text-lg font-black ${annualSavings < 0 ? 'text-red-900' : 'text-black'}`}>
                                {annualSavings > 0 ? '+' : ''}{annualSavings.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                             </span>
                         </div>
                    </div>
                    <div className="bg-watton-dark text-white p-2 flex flex-col justify-between shadow-xl relative overflow-hidden">
                        <div className={`absolute top-0 right-0 px-2 py-0.5 text-[8px] font-bold ${savingsPct < 0 ? 'bg-red-500' : 'bg-white/10'}`}>
                            {savingsPct > 0 ? '-' : '+'}{Math.abs(savingsPct).toFixed(1)}%
                        </div>
                        <span className="text-[8px] uppercase font-bold text-watton-lime tracking-widest text-center mt-2">Nova Fatura (Mensal)</span>
                        <div className="text-center z-10">
                             <span className="text-lg font-black text-white"><EditableNumber value={grandTotalWatton} onChange={()=>{}} digits={2} format="currency" bold colorClass="text-white" /></span>
                        </div>
                    </div>
                </div>

                <div className="mt-0 pt-2 border-t border-gray-200 h-28">
                    <h3 className="text-xs font-black text-watton-dark uppercase tracking-tight mb-2 flex items-center gap-2">
                        <span className="w-1 h-3 bg-watton-lime block"></span>
                        Estrat√©gia Recomendada
                    </h3>
                    <div className="text-[10px] font-semibold text-black leading-relaxed text-justify h-full overflow-hidden">
                        <EditableText value={strategyText} onChange={setStrategyText} multiline placeholder="Inserir an√°lise estrat√©gica..." />
                    </div>
                </div>

                <WattonPortfolioSection />
                <ReportFooter logoSmall={footerLogo} onUpload={setFooterLogo} />
            </div>

            {/* --- P√ÅGINA 2 --- */}
            <div className="relative flex flex-col justify-between p-10 bg-white overflow-hidden" style={{ width: '210mm', height: '296mm', boxSizing: 'border-box', position: 'relative' }}>
                <div className="flex-1 pb-16">
                    <div className="flex justify-between items-end mb-6 border-b-2 border-black pb-2">
                        <h2 className="text-xl font-black text-black uppercase tracking-tight">Contexto de Mercado</h2>
                        <div className="text-[9px] text-gray-500 font-bold uppercase tracking-[0.2em]">Data Intelligence</div>
                    </div>
                    <div className="flex flex-col gap-6 mb-8 items-center">
                        <div className="w-[80%] bg-white border border-gray-300 p-2 shadow-sm">
                            <div className="text-[9px] font-black text-black uppercase mb-1 tracking-wider pl-2 border-l-4 border-watton-lime">Hist√≥rico do Mercado Grossista</div>
                            <ImagePlaceholder src={marketGraphUrl} onUpload={setMarketGraphUrl} label="Inserir Gr√°fico de Mercado" className="h-[200px] w-full bg-white border border-gray-100" contain={true} />
                        </div>
                        <div className="w-[80%] bg-white border border-gray-300 p-2 shadow-sm">
                            <div className="text-[9px] font-black text-black uppercase mb-1 tracking-wider pl-2 border-l-4 border-watton-lime">Previs√£o do Mercado Grossista</div>
                            <ImagePlaceholder src={predictionGraphUrl} onUpload={setPredictionGraphUrl} label="Inserir Gr√°fico de Perfil" className="h-[200px] w-full bg-white border border-gray-100" contain={true} />
                        </div>
                    </div>
                    <div className="bg-gray-100 p-6 border-l-8 border-watton-dark mx-8 mt-auto">
                        <h4 className="font-black text-xs uppercase text-black mb-2 tracking-wide">Insight Executivo</h4>
                        <div className="text-[10px] font-bold text-gray-800 leading-relaxed italic">
                            <EditableText value={insightText} onChange={setInsightText} multiline />
                        </div>
                        <div className="mt-4 flex justify-between items-center bg-white p-3 border border-gray-200 shadow-sm">
                            <div className="flex gap-8">
                                <div className="flex flex-col"><span className="text-[8px] font-bold uppercase text-gray-500">Poupan√ßa Mensal</span><span className={`text-lg font-black ${monthlySavings < 0 ? 'text-red-600' : 'text-black'}`}>{monthlySavings.toLocaleString('pt-PT', {style: 'currency', currency: 'EUR'})}</span></div>
                                <div className="flex flex-col border-l border-gray-200 pl-6"><span className="text-[8px] font-bold uppercase text-gray-500">Recupera√ß√£o Anual</span><span className={`text-xl font-black ${annualSavings < 0 ? 'text-red-700' : 'text-watton-dark'}`}>{annualSavings.toLocaleString('pt-PT', {style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></div>
                            </div>
                            <div className="text-right">
                                <div className="text-[8px] font-bold uppercase text-gray-400">Classifica√ß√£o</div>
                                <div className="flex gap-1 mt-1">{[1,2,3,4,5].map(i => <div key={i} className={`w-2 h-2 rounded-full ${i <= 5 ? 'bg-watton-lime' : 'bg-gray-200'}`}></div>)}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <ReportFooter logoSmall={footerLogo} onUpload={setFooterLogo} />
            </div>

        </div>
      </div>
    </div>
  );
};
